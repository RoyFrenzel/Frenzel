[{"name":"app.r","content":"# Required Packages\r\nlibrary(shiny)\r\nlibrary(leaflet)\r\nlibrary(terra)\r\nlibrary(DT)\r\nlibrary(shinythemes)\r\nlibrary(munsell)\r\nlibrary(colorspace)\r\nlibrary(scales)\r\n\r\n# --- 1. CORE MATH ENGINE ---\r\nrossmo_formula <- function(dist_km, B, f, g) {\r\n  d <- terra::clamp(dist_km, lower = 0.0001)\r\n  above <- d >= B\r\n  below <- d < B\r\n  \r\n  part_above <- 1 / (d^f)\r\n  part_below <- (B^(g - f)) / (abs(2 * B - d)^g)\r\n  \r\n  res <- (above * part_above) + (below * part_below)\r\n  \r\n  res <- terra::classify(res, cbind(Inf, 0))\r\n  res <- terra::classify(res, cbind(NaN, 0))\r\n  return(res)\r\n}\r\n\r\n# --- 2. USER INTERFACE ---\r\nui <- fluidPage(\r\n  theme = shinytheme(\"flatly\"),\r\n  titlePanel(\"Psych 403 Geographic Profiling Assignment\"),\r\n  tags$p(\"R.R. Frenzel, PhD, RPsych\", \r\n         style = \"font-size: 14px; color: #555; margin-top: -10px; margin-bottom: 20px;\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      fileInput(\"file_upload\", \"1. Upload Crime Data (.csv)\", accept = c(\".csv\", \".txt\")),\r\n      helpText(\"Ensure headers are 'latitude' and 'longitude'\"),\r\n      hr(),\r\n      h4(\"Model Parameters\"),\r\n      sliderInput(\"buffer_b\", \"Rossmo Buffer (B) km:\", 0.1, 3.0, 0.5, 0.1),\r\n      sliderInput(\"decay_h\", \"Decay Constant (h):\", 0.1, 3.0, 0.5, 0.1),\r\n      hr(),\r\n      h4(\"Display Settings\"),\r\n      sliderInput(\"res_val\", \"Resolution (Grid Size):\", 40, 120, 60, 10),\r\n      sliderInput(\"alpha_val\", \"Heatmap Opacity:\", 0.1, 1.0, 0.5, 0.1),\r\n      hr(),\r\n      actionButton(\"run_calc\", \"Generate Profiles\", class = \"btn-primary btn-lg\", width = \"100%\"),\r\n      br(), br(),\r\n      # --- DOWNLOAD BUTTONS ---\r\n      downloadButton(\"download_map\", \"Export Analysis (JPG)\", class = \"btn-success\", style=\"width:100%\"),\r\n      br(), br(),\r\n      downloadButton(\"download_csv\", \"Download Data (CSV)\", class = \"btn-info\", style=\"width:100%\")\r\n    ),\r\n    \r\n    mainPanel(\r\n      tabsetPanel(\r\n        tabPanel(\"Rossmo Model\", \r\n                 leafletOutput(\"map_rossmo\", height = \"650px\")),\r\n        tabPanel(\"Distance Decay\", \r\n                 leafletOutput(\"map_decay\", height = \"650px\")),\r\n        tabPanel(\"Data Table\", \r\n                 DT::dataTableOutput(\"comparison_table\"))\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# --- 3. SERVER LOGIC ---\r\nserver <- function(input, output, session) {\r\n  \r\n  rigel_palette <- c(\"transparent\", \"#4B0082\", \"#0000FF\", \"#00FFFF\", \"#00FF00\", \"#FFFF00\", \"#FF7F00\", \"#FF0000\")\r\n  \r\n  points_df <- eventReactive(input$run_calc, {\r\n    req(input$file_upload)\r\n    df <- read.csv(input$file_upload$datapath, stringsAsFactors = FALSE)\r\n    names(df) <- tolower(trimws(names(df)))\r\n    df$lat <- as.numeric(df$latitude)\r\n    df$lon <- as.numeric(df$longitude)\r\n    df <- df[is.finite(df$lat) & is.finite(df$lon), ]\r\n    return(df)\r\n  })\r\n  \r\n  calc_results <- reactive({\r\n    df <- points_df()\r\n    req(nrow(df) > 0)\r\n    \r\n    v_pts <- terra::vect(df, geom = c(\"lon\", \"lat\"), crs = \"EPSG:4326\")\r\n    e <- terra::ext(v_pts)\r\n    grid_ext <- terra::ext(e[1]-0.05, e[2]+0.05, e[3]-0.05, e[4]+0.05)\r\n    \r\n    base_rast <- terra::rast(grid_ext, nrows = input$res_val, ncols = input$res_val, crs = \"EPSG:4326\")\r\n    rossmo_sum <- terra::init(base_rast, 0)\r\n    decay_sum  <- terra::init(base_rast, 0)\r\n    \r\n    for(i in 1:nrow(v_pts)) {\r\n      d_km <- terra::distance(base_rast, v_pts[i]) / 1000\r\n      rossmo_sum <- rossmo_sum + rossmo_formula(d_km, input$buffer_b, 1.2, 1.2)\r\n      decay_sum <- decay_sum + exp(-input$decay_h * d_km)\r\n    }\r\n    \r\n    norm_fn <- function(r) {\r\n      m <- terra::global(r, \"max\", na.rm = TRUE)[1,1]\r\n      if (!is.na(m) && m > 0) r/m else r\r\n    }\r\n    \r\n    list(rossmo = norm_fn(rossmo_sum), decay = norm_fn(decay_sum), points = v_pts)\r\n  })\r\n  \r\n  render_geo_map <- function(rast_data, v_pts, alpha) {\r\n    pal <- colorNumeric(palette = rigel_palette, domain = c(0, 1), na.color = \"transparent\")\r\n    leaflet() %>% \r\n      addTiles() %>%\r\n      addRasterImage(raster::raster(rast_data), colors = pal, opacity = alpha) %>%\r\n      addCircleMarkers(lng = terra::crds(v_pts)[,1], lat = terra::crds(v_pts)[,2], \r\n                       color = \"white\", fillColor = \"black\", radius = 5, weight = 2, fillOpacity = 1) %>%\r\n      addLegend(pal = pal, values = c(0, 1), title = \"Search Priority\",\r\n                labFormat = labelFormat(suffix = \"%\", transform = function(x) 100 * x), position = \"bottomright\")\r\n  }\r\n  \r\n  output$map_rossmo <- renderLeaflet({\r\n    res <- calc_results(); render_geo_map(res$rossmo, res$points, input$alpha_val)\r\n  })\r\n  \r\n  output$map_decay <- renderLeaflet({\r\n    res <- calc_results(); render_geo_map(res$decay, res$points, input$alpha_val)\r\n  })\r\n  \r\n  # --- CLEAN DATA TABLE (Removes redundant first 2 columns) ---\r\n  output$comparison_table <- DT::renderDataTable({\r\n    df <- points_df()\r\n    # Removes the original 2 columns, keeping only the processed 'lat' and 'lon'\r\n    datatable(df[, -c(1,2)], options = list(pageLength = 10))\r\n  })\r\n  \r\n  # --- HARDENED DOWNLOAD HANDLER: MAP (JPG) ---\r\n  output$download_map <- downloadHandler(\r\n    filename = function() { paste(\"Geographic_Profile_\", Sys.Date(), \".jpg\", sep=\"\") },\r\n    content = function(file) {\r\n      jpeg(file, width = 1200, height = 800, quality = 95, res = 120)\r\n      res <- calc_results()\r\n      par(mfrow = c(1, 2), mar = c(4, 4, 3, 2))\r\n      static_cols <- c(\"white\", \"#4B0082\", \"#0000FF\", \"#00FFFF\", \"#00FF00\", \"#FFFF00\", \"#FF7F00\", \"#FF0000\")\r\n      terra::plot(res$rossmo, main = \"Rossmo Model\", col = static_cols)\r\n      terra::plot(res$points, add = TRUE, col = \"black\", pch = 16, cex = 1.5)\r\n      terra::plot(res$decay, main = \"Distance Decay\", col = static_cols)\r\n      terra::plot(res$points, add = TRUE, col = \"black\", pch = 16, cex = 1.5)\r\n      dev.off()\r\n    },\r\n    contentType = \"image/jpeg\"\r\n  )\r\n  \r\n  # --- DOWNLOAD HANDLER: DATA (CSV) ---\r\n  output$download_csv <- downloadHandler(\r\n    filename = function() { paste(\"profiling-data-\", Sys.Date(), \".csv\", sep=\"\") },\r\n    content = function(file) {\r\n      write.csv(points_df(), file, row.names = FALSE)\r\n    }\r\n  )\r\n}\r\n\r\nshinyApp(ui = ui, server = server)\r\n","type":"text"}]
