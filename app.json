[{"name":"app.r","content":"# Required Packages\r\nlibrary(shiny)\r\nlibrary(leaflet)\r\nlibrary(terra)\r\nlibrary(DT)\r\nlibrary(shinythemes)\r\nlibrary(base64enc) # Essential for the Direct-to-Browser fix\r\n\r\n# --- 1. CORE MATH ENGINE ---\r\nrossmo_formula <- function(dist_km, B, f, g) {\r\n  d <- terra::clamp(dist_km, lower = 0.0001)\r\n  above <- d >= B\r\n  below <- d < B\r\n  part_above <- 1 / (d^f)\r\n  part_below <- (B^(g - f)) / (abs(2 * B - d)^g)\r\n  res <- (above * part_above) + (below * part_below)\r\n  res <- terra::classify(res, cbind(Inf, 0))\r\n  res <- terra::classify(res, cbind(NaN, 0))\r\n  return(res)\r\n}\r\n\r\n# --- 2. USER INTERFACE ---\r\nui <- fluidPage(\r\n  theme = shinytheme(\"flatly\"),\r\n  titlePanel(\"Psych 403 Geographic Profiling Assignment\"),\r\n  tags$p(\"R.R. Frenzel, PhD, RPsych\", \r\n         style = \"font-size: 14px; color: #555; margin-top: -10px; margin-bottom: 20px;\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      fileInput(\"file_upload\", \"1. Upload Crime Data (.csv)\", accept = c(\".csv\", \".txt\")),\r\n      hr(),\r\n      h4(\"Model Parameters\"),\r\n      sliderInput(\"buffer_b\", \"Rossmo Buffer (B) km:\", 0.1, 3.0, 0.5, 0.1),\r\n      sliderInput(\"decay_h\", \"Decay Constant (h):\", 0.1, 3.0, 0.5, 0.1),\r\n      hr(),\r\n      h4(\"Display Settings\"),\r\n      sliderInput(\"res_val\", \"Resolution (Grid Size):\", 40, 120, 60, 10),\r\n      sliderInput(\"alpha_val\", \"Heatmap Opacity:\", 0.1, 1.0, 0.5, 0.1),\r\n      hr(),\r\n      actionButton(\"run_calc\", \"Generate Profiles\", class = \"btn-primary btn-lg\", width = \"100%\"),\r\n      br(), br(),\r\n      # Special UI element to trigger the direct download\r\n      uiOutput(\"download_ui\")\r\n    ),\r\n    \r\n    mainPanel(\r\n      tabsetPanel(\r\n        tabPanel(\"Rossmo Model\", leafletOutput(\"map_rossmo\", height = \"650px\")),\r\n        tabPanel(\"Distance Decay\", leafletOutput(\"map_decay\", height = \"650px\")),\r\n        tabPanel(\"Data Table\", DT::dataTableOutput(\"comparison_table\"))\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# --- 3. SERVER LOGIC ---\r\nserver <- function(input, output, session) {\r\n  \r\n  rigel_palette <- c(\"transparent\", \"#4B0082\", \"#0000FF\", \"#00FFFF\", \"#00FF00\", \"#FFFF00\", \"#FF7F00\", \"#FF0000\")\r\n  \r\n  points_df <- eventReactive(input$run_calc, {\r\n    req(input$file_upload)\r\n    df <- read.csv(input$file_upload$datapath, stringsAsFactors = FALSE)\r\n    names(df) <- tolower(trimws(names(df)))\r\n    df$lat <- as.numeric(df$latitude)\r\n    df$lon <- as.numeric(df$longitude)\r\n    return(df[is.finite(df$lat) & is.finite(df$lon), ])\r\n  })\r\n  \r\n  calc_results <- reactive({\r\n    df <- points_df()\r\n    req(nrow(df) > 0)\r\n    v_pts <- terra::vect(df, geom = c(\"lon\", \"lat\"), crs = \"EPSG:4326\")\r\n    e <- terra::ext(v_pts)\r\n    grid_ext <- terra::ext(e[1]-0.05, e[2]+0.05, e[3]-0.05, e[4]+0.05)\r\n    base_rast <- terra::rast(grid_ext, nrows = input$res_val, ncols = input$res_val, crs = \"EPSG:4326\")\r\n    rossmo_sum <- terra::init(base_rast, 0); decay_sum <- terra::init(base_rast, 0)\r\n    for(i in 1:nrow(v_pts)) {\r\n      d_km <- terra::distance(base_rast, v_pts[i]) / 1000\r\n      rossmo_sum <- rossmo_sum + rossmo_formula(d_km, input$buffer_b, 1.2, 1.2)\r\n      decay_sum <- decay_sum + exp(-input$decay_h * d_km)\r\n    }\r\n    norm_fn <- function(r) { m <- terra::global(r, \"max\", na.rm = TRUE)[1,1]; if (!is.na(m) && m > 0) r/m else r }\r\n    list(rossmo = norm_fn(rossmo_sum), decay = norm_fn(decay_sum), points = v_pts)\r\n  })\r\n  \r\n  output$map_rossmo <- renderLeaflet({\r\n    res <- calc_results(); pal <- colorNumeric(rigel_palette, c(0, 1), na.color = \"transparent\")\r\n    leaflet() %>% addTiles() %>% addRasterImage(raster::raster(res$rossmo), colors = pal, opacity = input$alpha_val) %>%\r\n      addCircleMarkers(lng = terra::crds(res$points)[,1], lat = terra::crds(res$points)[,2], color = \"white\", fillColor = \"black\", radius = 5, fillOpacity = 1)\r\n  })\r\n  \r\n  output$map_decay <- renderLeaflet({\r\n    res <- calc_results(); pal <- colorNumeric(rigel_palette, c(0, 1), na.color = \"transparent\")\r\n    leaflet() %>% addTiles() %>% addRasterImage(raster::raster(res$decay), colors = pal, opacity = input$alpha_val) %>%\r\n      addCircleMarkers(lng = terra::crds(res$points)[,1], lat = terra::crds(res$points)[,2], color = \"white\", fillColor = \"black\", radius = 5, fillOpacity = 1)\r\n  })\r\n  \r\n  # --- THE \"NUCLEAR\" DOWNLOAD LOGIC ---\r\n  output$download_ui <- renderUI({\r\n    req(input$run_calc)\r\n    \r\n    # 1. Create the high-res smoothed plot in the background\r\n    tmp <- tempfile(fileext = \".jpg\")\r\n    jpeg(tmp, width = 2400, height = 1600, quality = 100, res = 300)\r\n    res <- calc_results()\r\n    par(mfrow = c(1, 2), mar = c(5, 5, 4, 2))\r\n    static_cols <- c(\"white\", \"#4B0082\", \"#0000FF\", \"#00FFFF\", \"#00FF00\", \"#FFFF00\", \"#FF7F00\", \"#FF0000\")\r\n    smooth_rast <- function(r) { terra::disagg(r, fact = 4, method = \"bilinear\") }\r\n    \r\n    terra::plot(smooth_rast(res$rossmo), main = \"Rossmo Model\", col = static_cols)\r\n    terra::plot(res$points, add = TRUE, col = \"black\", pch = 16, cex = 1.0)\r\n    terra::plot(smooth_rast(res$decay), main = \"Distance Decay\", col = static_cols)\r\n    terra::plot(res$points, add = TRUE, col = \"black\", pch = 16, cex = 1.0)\r\n    dev.off()\r\n    \r\n    # 2. Convert that file into a Base64 text string\r\n    b64 <- base64enc::dataURI(file = tmp, mime = \"image/jpeg\")\r\n    \r\n    # 3. Create a download link that contains the DATA itself\r\n    tags$a(\r\n      href = b64,\r\n      download = paste0(\"Geographic_Profile_\", Sys.Date(), \".jpg\"),\r\n      class = \"btn btn-success\",\r\n      style = \"width: 100%; text-decoration: none; color: white; text-align: center; display: inline-block; padding: 10px;\",\r\n      \"Download Comparison Image (JPG)\"\r\n    )\r\n  })\r\n  \r\n  output$comparison_table <- DT::renderDataTable({ datatable(points_df()[, -c(1,2)]) })\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"}]
